generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== User & Authentication ====================

enum Role {
  APPLICANT
  EMPLOYER
  ADMIN
}

model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  password                String
  role                    Role
  isActive                Boolean   @default(true)
  isEmailVerified         Boolean   @default(false)
  emailVerificationOtp    String?
  emailVerificationExpiry DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  profile  Profile?
  employer Employer?

  @@index([email])
}

model Profile {
  id           String    @id @default(cuid())
  userId       String    @unique
  firstName    String
  lastName     String
  phone        String
  nationality  String
  dateOfBirth  DateTime?
  aiGeneratedCV Json?
  cvFileUrl    String?
  trustScore   Int       @default(50)
  rewardPoints Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications      Application[]
  complaints        Complaint[]
  employerRatings   EmployerRating[]
  applicantRatings  ApplicantRating[]

  @@index([userId])
}

model Employer {
  id                String    @id @default(cuid())
  userId            String    @unique
  companyName       String
  contactPerson     String
  phone             String
  country           String
  isVerified        Boolean   @default(false)
  verificationDocs  Json?
  trustScore        Int       @default(50)
  totalHires        Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobOrders         JobOrder[]
  invoices          Invoice[]
  employerRatings   EmployerRating[]
  applicantRatings  ApplicantRating[]

  @@index([userId])
}

enum JobStatus {
  ACTIVE
  FILLED
  CANCELLED
  EXPIRED
}

model JobOrder {
  id           String    @id @default(cuid())
  employerId   String
  title        String
  description  String    @db.Text
  requirements Json
  salary       Float?
  location     String
  positions    Int
  status       JobStatus @default(ACTIVE)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  employer     Employer      @relation(fields: [employerId], references: [id], onDelete: Cascade)
  applications Application[]

  @@index([employerId])
  @@index([status])
}

enum ApplicationStatus {
  APPLIED
  SHORTLISTED
  INTERVIEWED
  SELECTED
  PROCESSING
  DEPLOYED
  REJECTED
}

model Application {
  id               String            @id @default(cuid())
  applicantId      String
  jobOrderId       String
  status           ApplicationStatus @default(APPLIED)
  aiMatchScore     Int?
  shortlistedAt    DateTime?
  interviewedAt    DateTime?
  selectedAt       DateTime?
  deployedAt       DateTime?
  videoInterviewUrl String?
  interviewNotes   String?           @db.Text
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  applicant  Profile     @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  jobOrder   JobOrder    @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)
  deployment Deployment?

  @@index([applicantId])
  @@index([jobOrderId])
  @@index([status])
}

enum ComplianceStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  EXPIRED
}

model Deployment {
  id                String           @id @default(cuid())
  applicationId     String           @unique
  medicalStatus     ComplianceStatus @default(PENDING)
  medicalExpiryDate DateTime?
  visaStatus        ComplianceStatus @default(PENDING)
  visaExpiryDate    DateTime?
  oecStatus         ComplianceStatus @default(PENDING)
  oecNumber         String?
  flightDate        DateTime?
  arrivalDate       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

enum ComplaintCategory {
  EMPLOYER_ISSUE
  AGENCY_ISSUE
  DEPLOYMENT_DELAY
  CONTRACT_VIOLATION
  ABUSE
  OTHER
}

enum ComplaintStatus {
  SUBMITTED
  UNDER_REVIEW
  ESCALATED
  RESOLVED
  CLOSED
}

model Complaint {
  id              String            @id @default(cuid())
  applicantId     String
  category        ComplaintCategory
  description     String            @db.Text
  status          ComplaintStatus   @default(SUBMITTED)
  assignedAdminId String?
  resolution      String?           @db.Text
  resolvedAt      DateTime?
  isAnonymous     Boolean           @default(false)
  escalationLevel Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  applicant Profile @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  @@index([applicantId])
  @@index([status])
}

model EmployerRating {
  id         String   @id @default(cuid())
  employerId String
  applicantId String
  rating     Int
  review     String?  @db.Text
  createdAt  DateTime @default(now())

  employer  Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)
  applicant Profile  @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([applicantId])
}

model ApplicantRating {
  id          String   @id @default(cuid())
  applicantId String
  employerId  String
  rating      Int
  review      String?  @db.Text
  createdAt   DateTime @default(now())

  applicant Profile  @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  employer  Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([applicantId])
  @@index([employerId])
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id            String        @id @default(cuid())
  employerId    String
  invoiceNumber String        @unique
  amount        Float
  currency      String        @default("PHP")
  status        InvoiceStatus @default(PENDING)
  dueDate       DateTime
  paidAt        DateTime?
  lineItems     Json
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([status])
}